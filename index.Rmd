---
output:
  html_document:
    self_contained: true
---

<div class="header-logo">
  <img src="images/survivor.png" />
</div>
<h1 class="title">Survivor 50 Bingo!</h1>

```{r setup, echo=FALSE}

# Check and load data with better error handling
tryCatch({
  prompts <- read.csv("data/prompts.csv", stringsAsFactors = FALSE)
  picks   <- read.csv("data/picks.csv", stringsAsFactors = FALSE)
  marks   <- read.csv("data/marks.csv", stringsAsFactors = FALSE)
  cards   <- readRDS("data/cards.rds")
}, error = function(e) {
  stop("Error loading data files. Please ensure the following structure exists:\n",
       "  - data/prompts.csv\n",
       "  - data/picks.csv\n",
       "  - data/marks.csv\n",
       "  - data/cards.rds\n",
       "Current working directory: ", getwd(), "\n",
       "Error message: ", e$message)
})

# Ensure consistent types
marks$id <- as.character(marks$id)
prompts$prompt_id <- as.numeric(prompts$prompt_id)

# Basic validation
stopifnot(
  all(names(cards) %in% picks$player),
  all(as.numeric(marks$id[marks$type == "prompt"]) %in% prompts$prompt_id)
)

```

```{r helpers, echo=FALSE}

get_mark <- function(id, type, marks) {
  hit <- marks$hit[marks$id == as.character(id) & marks$type == type]
  if (length(hit) == 0 || hit == 0) "" else "X"
}

```

```{r cell_renderer, echo=FALSE}

render_cell <- function(value, prompts, marks, picks, player) {
  value <- as.numeric(value)
  # FREE SPACE
  if (is.na(value)) {
  return(
    "<div class='cell free'>
       <span class='text'>FREE<br>'The tribe has spoken'</span>
       <span class='mark'>X</span>
     </div>")}
  # WINNER PICK
  if (value < 0 && value > -1000) {
    winner <- picks$winner_text[picks$player == player]
    winner <- ifelse(length(winner) == 0, "—", winner)
    mark   <- get_mark(player, "winner", marks)
    return(
      tags$div(
        class = "cell winner",
        tags$span(
          class = "text",
          HTML(paste0("Winner Pick:<br><strong>", winner, "</strong>"))),
        tags$span(class = "mark", mark)))}
  # LOSER PICK
  if (value <= -1000) {
    loser <- picks$loser_text[picks$player == player]
    loser <- ifelse(length(loser) == 0, "—", loser)
    mark  <- get_mark(player, "loser", marks)
    return(
      tags$div(
        class = "cell loser",
        tags$span(
          class = "text",
          HTML(paste0("Loser Pick:<br><strong>", loser, "</strong>"))),
        tags$span(class = "mark", mark)))}
  # PROMPT
  text <- prompts$prompt_text[prompts$prompt_id == value]
  mark <- get_mark(value, "prompt", marks)
  tags$div(
    class = "cell",
    tags$span(class = "text", text),
    tags$span(class = "mark", mark))}

```

```{r card_renderer, echo=FALSE, results='asis'}

render_card <- function(card, prompts, marks, picks, player) {
  cells <- apply(
    card, c(1, 2),
    function(x) render_cell(x, prompts, marks, picks, player))
  tagList(
    tags$div(
      class = "card",
      tags$h3(player),
      tags$div(
        class = "grid",
        cells)))}

```

```{=html}
<style>

@font-face {
  font-family: "Survivant";
  src: url("font/survivant.woff2") format("woff2");
  font-weight: normal;
  font-style: normal;
}

/* Base styles */
body {
  background-color: #E2DED6;  
  font-family: "Survivant", "Inter Tight";
  color: #333;  
  padding: 20px;
  margin: 0;
  -webkit-overflow-scrolling: touch;
}

.header-logo {
  text-align: center;
  margin-bottom: 20px;
}

.header-logo img {
  max-width: 100%;
  height: auto;
  max-height: 150px;
}

h1.title {
  font-weight: 700;      
  font-size: clamp(2em, 8vw, 3em); 
  text-align: center;    
  margin-bottom: 10px;
  word-wrap: break-word;
}

/* Card container */
.card { 
  display: block;
  margin: 15px auto;
  width: 100%;
  max-width: 600px;
  box-sizing: border-box;
}

.card h3 {
  font-size: clamp(1.2em, 4vw, 1.5em);
  text-align: center;
  margin-bottom: 10px;
}

/* Grid layout */
.grid { 
  display: grid; 
  grid-template-columns: repeat(5, 1fr); 
  gap: 4px;
  width: 100%;
  max-width: 600px;
  margin: 0 auto;
  box-sizing: border-box;
}

/* Cell styles */
.cell {
  background: #eee;
  border: 1px solid #333;
  padding: 6px;
  min-height: 80px;
  position: relative;
  font-size: clamp(9px, 1.8vw, 11px); /* Smaller text */
  box-sizing: border-box;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
}

.cell .text {
  word-wrap: break-word;
  overflow-wrap: break-word;
  hyphens: auto;
  max-width: 100%;
  line-height: 1.1;
  padding: 2px;
}

.cell.free {
  background: #D1CFC7;
  font-weight: bold;
  text-align: center;
  display: grid;
  place-items: center;
}

.cell.winner {
  background: #fff3cd;
  border: 2px solid #f0ad4e;
  text-align: center;
  display: grid;
  place-items: center;
}

.cell.loser {
  background: #f8d7da;
  border: 2px solid #dc3545;
  text-align: center;
  display: grid;
  place-items: center;
}

.mark {
  background: transparent;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: clamp(40px, 10vw, 60px);
  font-weight: bold;
  color: rgb(0, 0, 0);
  opacity: 0.5;
  pointer-events: none; /* Prevents blocking text selection */
}

/* Table of contents */
.toc {
  text-align: center;
  margin: 30px auto;
  padding: 15px;
  background: transparent;
  border-radius: 4px;
  max-width: 800px;
}

.toc a {
  display: inline-block;
  margin: 5px;
  padding: 8px 16px;
  background: #D1CFC7;
  color: #333;
  text-decoration: none;
  border-radius: 4px;
  font-size: clamp(0.9em, 3vw, 1em);
  min-height: 44px;
  min-width: 44px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.toc a:hover {
  background: #bfbdb5;
}

/* Mobile optimizations */
@media (max-width: 768px) {
  body {
    padding: 10px;
  }
  
  .header-logo img {
    max-height: 100px;
  }
  
  .card {
    margin: 10px 0;
    padding: 0;
    width: 100%;
    max-width: 100%;
  }
  
  .grid {
    gap: 3px;
    width: 100%;
    max-width: 100%;
  }
  
  .cell {
    padding: 4px;
    min-height: 60px;
  }
  
  .toc {
    padding: 10px;
  }
  
  .toc a {
    margin: 3px;
    padding: 6px 12px;
  }
}

/* Extra small screens */
@media (max-width: 480px) {
  body {
    padding: 5px;
  }
  
  .header-logo img {
    max-height: 80px;
  }
  
  h1.title {
    margin-bottom: 5px;
  }
  
  .card {
    margin: 5px auto;
  }
  
  .grid {
    gap: 2px;
  }
  
  .cell {
    padding: 3px;
    min-height: 50px;
    border-width: 1px;
  }
  
  .cell.winner,
  .cell.loser {
    border-width: 1px;
  }
}

/* Landscape orientation on mobile */
@media (max-width: 768px) and (orientation: landscape) {
  .grid {
    max-width: 80vh;
  }
}

/* Print styles */
@media print {
  body {
    background-color: white;
  }
  
  .toc {
    display: none;
  }
  
  .card {
    page-break-inside: avoid;
    margin: 20px;
  }
}

</style>
```

```{r html_render_helpers, echo=FALSE}

library(htmltools)

render_cell_tag <- function(value, prompts, marks, picks, player) {
  value <- as.numeric(value)
  if (is.na(value)) {
  return(
    tags$div(
      tags$span("FREE SPACE", style = "display:block; font-weight:bold;"),
      tags$span("'The tribe has spoken'", style = "display:block;"),
      tags$span("X", class = "mark"),
      class = "cell free"))}
  if (value < 0 && value > -1000) {
    winner <- picks$winner_text[picks$player == player]
    mark <- get_mark(player, "winner", marks)
    return(tags$div(
      tags$span(paste0("Winner Pick:\n", winner), class="text"),
      tags$span(mark, class="mark"),
      class="cell winner"))}
  if (value <= -1000) {
    loser <- picks$loser_text[picks$player == player]
    mark <- get_mark(player, "loser", marks)
    return(tags$div(
      tags$span(paste0("Loser Pick:\n", loser), class="text"),
      tags$span(mark, class="mark"),
      class="cell loser"))}
  text <- prompts$prompt_text[prompts$prompt_id == value]
  mark <- get_mark(value, "prompt", marks)
  tags$div(
    tags$span(text, class="text"),
    tags$span(mark, class="mark"),
    class="cell")}

render_card_tag <- function(card, prompts, marks, picks, player) {
  rows <- lapply(seq_len(nrow(card)), function(r) {
    row_cells <- lapply(seq_len(ncol(card)), function(c) {
      render_cell_tag(card[r, c], prompts, marks, picks, player)})
    row_cells})
  cells <- unlist(rows, recursive = FALSE)
  tags$div(
    id = paste0("card-", player),
    tags$h3(player),
    tags$div(cells, class = "grid"),
    class = "card")}

```

```{r render_cards, results='asis', echo=FALSE}

toc_links <- lapply(names(cards), function(player) {
  tags$a(href = paste0("#card-", player), player)
})

tags$div(
  class = "toc",
  tagList(toc_links)
)

all_cards <- lapply(names(cards), function(player) {
  render_card_tag(cards[[player]], prompts, marks, picks, player)
})

browsable(tagList(all_cards))

```
